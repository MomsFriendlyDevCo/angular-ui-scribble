"use strict";angular.module("angular-ui-scribble",[]).factory("$debounce",["$timeout",function(t){return function(e,a,n){a=angular.isUndefined(a)?0:a,n=!!angular.isUndefined(n)||n;var i=0;return function(){var r=this,s=arguments,o=function(t){return function(){if(t===i)return e.apply(r,s)}}(++i);return t(o,a,n)}}}]).directive("uiScribble",function(){return{scope:{callback:"&",editable:"<",buttons:"<",width:"@?",height:"@?",sizes:"<",colors:"<"},template:'\n\t\t\t<div class="scribble" ng-class="editable ? \'scribble-editable\' : \'scribble-not-editable\'">\n\t\t\t\t<input class="scribble-file-camera selectBackground-image" type="file" accept="image/*" >\n\t\t\t\t<input class="scribble-file-camera selectBackground-video" type="file" accept="image/*" capture="camera">\n\t\t\t\t<nav ng-if="editable" class="scribble-actions navbar navbar-default" style="width: {{width}}px">\n\t\t\t\t\t<div class="navbar-form pull-left">\n\t\t\t\t\t\t<div ng-if="buttons.camera" class="btn-group">\n\t\t\t\t\t\t\t<a ng-if="mode!=\'streaming\' && !isMobile" tooltip="Set background image" ng-click="setBackground()" class="btn btn-primary"><i class="fa fa-camera"></i></a>\n\t\t\t\t\t\t\t<a ng-if="mode==\'streaming\' && !isMobile" tooltip="Take screenshot" ng-click="screenshot()" class="btn btn-primary"><i class="fa fa-camera"></i></a>\n\t\t\t\t\t\t\t<a ng-if="isMobile" ng-click="requestCamera(\'video\')" class="btn btn-primary"><i class="fa fa-camera"></i></a>\n\t\t\t\t\t\t\t<a ng-click="requestCamera(\'image\')" class="btn btn-primary"><i class="fa fa-paperclip"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="btn-group">\n\t\t\t\t\t\t\t<a ng-click="setMode(\'pen\')" ng-class="mode==\'pen\' && \'active\'" tooltip="Pen" class="btn btn-default"><i class="fa fa-pencil"></i></a>\n\t\t\t\t\t\t\t<a ng-if="buttons.eraser" ng-click="setMode(\'erase\')" ng-class="mode==\'erase\' && \'active\'" tooltip="Eraser" class="btn btn-default"><i class="fa fa-eraser"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div ng-if="buttons.sizes" class="btn-group scribble-pens">\n\t\t\t\t\t\t\t<a ng-repeat="size in sizes" ng-click="setPenSize(size)" ng-class="penSize==size && \'active\'" tooltip="Pen Size {{size}}" class="btn btn-default"><i class="fa fa-circle" style="transform: scale({{$index / sizes.length + 0.2}})"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div ng-if="buttons.colors" class="btn-group scribble-colors">\n\t\t\t\t\t\t\t<a ng-repeat="color in colors" ng-click="setPenColor(color)" ng-class="penColor==color && \'active\'" tooltip="Pen Color {{color}}" class="btn btn-default"><i class="fa fa-square" style="color: {{color}}"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div ng-if="buttons.clear" class="navbar-form pull-right">\n\t\t\t\t\t\t<div class="btn-group">\n\t\t\t\t\t\t\t<a ng-click="clearSignature()" class="btn btn-danger"><i class="fa fa-trash"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</nav>\n\t\t\t\t<div class="scribble-area" style="width: {{width}}px; height: {{height}}px">\n\t\t\t\t\t<canvas class="scribble-board" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t\t\t<video class="scribble-video" ng-show="mode==\'streaming\'" height="{{height}}" width="{{width}}" autoplay></video>\n\t\t\t\t\t<canvas class="scribble-background" ng-show="mode!=\'streaming\'" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t\t\t<a ng-if="signatureReady" ng-click="submit()" class="btn btn-success btn-circular btn-fab"><i class="fa fa-fw fa-check fa-2x"></i></a>\n\t\t\t\t</div>\n\t\t\t\t<canvas class="scribble-composed" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t</div>\n\t\t',controller:["$scope","$element","$debounce",function(t,e,a){function n(t){return function(){if(t.files.length){var e=t.files[0],a=new FileReader;a.onload=function(t){var e=new Image;e.src=t.target.result,e.onload=function(){return i(e)}},a&&a.readAsDataURL(e)}}}function i(e){t.$applyAsync(function(){t.reversed&&t.flipContext(),t.signatureReady=!0,d.clearRect(0,0,s.width,s.height),d.drawImage(e,0,0,l.width,l.height)})}var r=navigator.userAgent;t.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(r),t.requestCamera=function(a){t.setMode("pen"),c&&c.getTracks()[0]&&c.getTracks()[0].stop(),e.find(".selectBackground-"+a).trigger("click")},t.height||(t.height=200),t.width||(t.width=490),t.sizes||(t.sizes=[1,2,3,4,5]),t.colors||(t.colors=["#000","#337AB7","#3C763D","#8A6D3B","#A94442"]),t.buttons=Object.assign({camera:!0,colors:!0,clear:!0,eraser:!0,sizes:!0},t.buttons);var s=e[0].querySelector(".scribble-board"),o=s.getContext("2d");t.signaturePad=new SignaturePad(s);var c,l=e[0].querySelector(".scribble-background"),d=l.getContext("2d"),g=e[0].querySelector(".scribble-composed"),u=g.getContext("2d"),b=e[0].querySelector(".scribble-video");navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia,t.setBackground=function(){navigator.getUserMedia&&navigator.getUserMedia({video:!0},function(e){t.$applyAsync(function(){t.signatureReady=!1,d&&d.clearRect(0,0,s.width,s.height),b.src=window.URL.createObjectURL(e),c=e,t.setMode("streaming")})},function(){return alert("Camera unavailable")})},t.reversed=!1,t.flipContext=function(){t.reversed=!t.reversed,d.translate(l.width,0),d.scale(-1,1)},t.screenshot=function(){if(t.setMode("pen"),t.signatureReady=!1,(b.paused||b.ended)&&console.log("no video"),b.paused||b.ended)return!1;t.reversed||t.flipContext(),d.drawImage(b,0,0,t.width,t.height),c.getTracks()[0].stop(),t.signatureReady=!0},t.clearSignature=function(){return t.signaturePad.clear()},t.signaturePad.onBegin=function(){return t.$applyAsync(function(){return t.signatureReady=!1})},t.signaturePad.onEnd=a(function(){return t.$applyAsync(function(){t.editable?t.signatureReady=!0:t.submit()})},1500,!1),t.mode="pen",t.setMode=function(e){return t.mode=e},t.$watch("mode",function(e,a){"erase"==e&&e!==a?(t.oldStroke={oldComposition:o.globalCompositeOperation,minWidth:t.signaturePad.minWidth,maxWidth:t.signaturePad.maxWidth},o.globalCompositeOperation="destination-out",t.signaturePad.minWidth=6,t.signaturePad.maxWidth=8):"erase"==a&&(o.globalCompositeOperation=t.oldStroke.oldComposition,t.signaturePad.minWidth=t.oldStroke.minWidth,t.signaturePad.maxWidth=t.oldStroke.maxWidth)}),t.penSize=1,t.setPenSize=function(e){t.penSize=e,t.signaturePad.minWidth=e-.5,t.signaturePad.maxWidth=e+1.5},t.penColor="#000",t.setPenColor=function(e){t.penColor=e,t.signaturePad.penColor=e};var f=e[0].querySelector(".selectBackground-image"),h=e[0].querySelector(".selectBackground-video");f.addEventListener("change",n(f)),h.addEventListener("change",n(h)),t.getDataURI=function(){return u.clearRect(0,0,g.width,g.height),u.drawImage(l,0,0),u.drawImage(s,0,0),g.toDataURL()},t.getBlob=function(t){for(var e=atob(t.replace(/^data:image\/png;base64,/,"")),a=new Uint8Array(e.length),n=0;n<e.length;n++)a[n]=e.charCodeAt(n);return new Blob([a],{type:"image/png"})},t.submit=function(){var e=t.getDataURI();t.callback({dataURI:e,blob:t.getBlob(e)})}}]}});