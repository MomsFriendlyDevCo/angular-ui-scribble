"use strict";angular.module("angular-ui-scribble",[]).factory("$debounce",["$timeout",function(t){return function(e,a,i){a=angular.isUndefined(a)?0:a,i=!!angular.isUndefined(i)||i;var n=0;return function(){var s=this,r=arguments,o=function(t){return function(){if(t===n)return e.apply(s,r)}}(++n);return t(o,a,i)}}}]).directive("uiScribble",function(){return{scope:{callback:"&",editable:"<",buttons:"<",width:"@?",height:"@?",sizes:"<",colors:"<"},template:'\n\t\t\t<div class="scribble" ng-class="editable ? \'scribble-editable\' : \'scribble-not-editable\'">\n\t\t\t\t<input class="scribble-file-camera selectBackground" type="file" accept="image/*" capture="camera">\n\t\t\t\t<nav ng-if="editable" class="scribble-actions navbar navbar-default" style="width: {{width}}px">\n\t\t\t\t\t<div class="navbar-form pull-left">\n\t\t\t\t\t\t<div ng-if="buttons.camera" class="btn-group">\n\t\t\t\t\t\t\t<a ng-if="mode!=\'streaming\' && !isMobile" tooltip="Set background image" ng-click="setBackground()" class="btn btn-primary"><i class="fa fa-image"></i></a>\n\t\t\t\t\t\t\t<a ng-if="mode==\'streaming\' && !isMobile" tooltip="Take screenshot" ng-click="screenshot()" class="btn btn-primary"><i class="fa fa-camera"></i></a>\n\t\t\t\t\t\t\t<a ng-if="isMobile" ng-click="requestCamera()" class="btn btn-primary"><i class="fa fa-camera"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="btn-group">\n\t\t\t\t\t\t\t<a ng-click="setMode(\'pen\')" ng-class="mode==\'pen\' && \'active\'" tooltip="Pen" class="btn btn-default"><i class="fa fa-pencil"></i></a>\n\t\t\t\t\t\t\t<a ng-if="buttons.eraser" ng-click="setMode(\'erase\')" ng-class="mode==\'erase\' && \'active\'" tooltip="Eraser" class="btn btn-default"><i class="fa fa-eraser"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div ng-if="buttons.sizes" class="btn-group scribble-pens">\n\t\t\t\t\t\t\t<a ng-repeat="size in sizes" ng-click="setPenSize(size)" ng-class="penSize==size && \'active\'" tooltip="Pen Size {{size}}" class="btn btn-default"><i class="fa fa-circle" style="transform: scale({{$index / sizes.length + 0.2}})"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div ng-if="buttons.colors" class="btn-group scribble-colors">\n\t\t\t\t\t\t\t<a ng-repeat="color in colors" ng-click="setPenColor(color)" ng-class="penColor==color && \'active\'" tooltip="Pen Color {{color}}" class="btn btn-default"><i class="fa fa-square" style="color: {{color}}"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div ng-if="buttons.clear" class="navbar-form pull-right">\n\t\t\t\t\t\t<div class="btn-group">\n\t\t\t\t\t\t\t<a ng-click="clearSignature()" class="btn btn-danger"><i class="fa fa-trash"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</nav>\n\t\t\t\t<div class="scribble-area" style="width: {{width}}px; height: {{height}}px">\n\t\t\t\t\t<canvas class="scribble-board" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t\t\t<video class="scribble-video" ng-show="mode==\'streaming\'" height="{{height}}" width="{{width}}" autoplay></video>\n\t\t\t\t\t<canvas class="scribble-background" ng-show="mode!=\'streaming\'" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t\t\t<a ng-if="signatureReady" ng-click="submit()" class="btn btn-success btn-circular btn-fab"><i class="fa fa-fw fa-check fa-2x"></i></a>\n\t\t\t\t</div>\n\t\t\t\t<canvas class="scribble-composed" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t</div>\n\t\t',controller:["$scope","$element","$debounce",function(t,e,a){var i=navigator.userAgent;t.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(i),t.requestCamera=function(){return e.find("input[type=file]").trigger("click")},t.height||(t.height=200),t.width||(t.width=490),t.sizes||(t.sizes=[1,2,3,4,5]),t.colors||(t.colors=["#000","#337AB7","#3C763D","#8A6D3B","#A94442"]),t.buttons=Object.assign({camera:!0,colors:!0,clear:!0,eraser:!0,sizes:!0},t.buttons);var n=e[0].querySelector(".scribble-board"),s=n.getContext("2d");t.signaturePad=new SignaturePad(n);var r,o=e[0].querySelector(".scribble-background"),c=o.getContext("2d"),l=e[0].querySelector(".scribble-composed"),d=l.getContext("2d"),g=e[0].querySelector(".scribble-video");navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia,t.setBackground=function(){t.setMode("streaming"),navigator.getUserMedia&&navigator.getUserMedia({video:!0},function(t){g.src=window.URL.createObjectURL(t),r=t},function(){})},t.reversed=!1,t.screenshot=function(){if(t.setMode("pen"),(g.paused||g.ended)&&console.log("no video"),g.paused||g.ended)return!1;t.reversed||(t.reversed=!0,c.translate(o.width,0),c.scale(-1,1)),c.drawImage(g,0,0,t.width,t.height),r.getTracks()[0].stop()},t.clearSignature=function(){return t.signaturePad.clear()},t.signaturePad.onBegin=function(){return t.$applyAsync(function(){return t.signatureReady=!1})},t.signaturePad.onEnd=a(function(){return t.$applyAsync(function(){t.editable?t.signatureReady=!0:t.submit()})},1500,!1),t.mode="pen",t.setMode=function(e){return t.mode=e},t.$watch("mode",function(e,a){"erase"==e&&e!==a?(t.oldStroke={oldComposition:s.globalCompositeOperation,minWidth:t.signaturePad.minWidth,maxWidth:t.signaturePad.maxWidth},s.globalCompositeOperation="destination-out",t.signaturePad.minWidth=6,t.signaturePad.maxWidth=8):"erase"==a&&(s.globalCompositeOperation=t.oldStroke.oldComposition,t.signaturePad.minWidth=t.oldStroke.minWidth,t.signaturePad.maxWidth=t.oldStroke.maxWidth)}),t.penSize=1,t.setPenSize=function(e){t.penSize=e,t.signaturePad.minWidth=e-.5,t.signaturePad.maxWidth=e+1.5},t.penColor="#000",t.setPenColor=function(e){t.penColor=e,t.signaturePad.penColor=e};var u=e[0].querySelector(".selectBackground");u.addEventListener("change",function(t){var e=u.files[0],a=new FileReader;a.onload=function(t){var e=new Image;window.devicePixelRatio;e.src=t.target.result,e.onload=function(){c.clearRect(0,0,n.width,n.height),c.drawImage(e,0,0,o.width,o.height)}},a.readAsDataURL(e)}),t.getDataURI=function(){return d.clearRect(0,0,l.width,l.height),d.drawImage(o,0,0),d.drawImage(n,0,0),l.toDataURL()},t.getBlob=function(t){for(var e=atob(t.replace(/^data:image\/png;base64,/,"")),a=new Uint8Array(e.length),i=0;i<e.length;i++)a[i]=e.charCodeAt(i);return new Blob([a],{type:"image/png"})},t.submit=function(){var e=t.getDataURI();t.callback({dataURI:e,blob:t.getBlob(e)})}}]}});