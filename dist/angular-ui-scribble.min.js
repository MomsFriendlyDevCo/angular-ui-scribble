"use strict";angular.module("angular-ui-scribble",[]).factory("$debounce",["$timeout",function($timeout){function debounce(callback,timeout,apply){timeout=angular.isUndefined(timeout)?0:timeout,apply=!!angular.isUndefined(apply)||apply;var callCount=0;return function(){var self=this,args=arguments;callCount++;var wrappedCallback=function(version){return function(){if(version===callCount)return callback.apply(self,args)}}(callCount);return $timeout(wrappedCallback,timeout,apply)}}return debounce}]).directive("uiScribble",function(){return{scope:{callback:"&",editable:"<",buttons:"<",width:"@?",height:"@?"},template:'\n\t\t\t<div class="scribble" ng-class="editable ? \'scribble-editable\' : \'scribble-not-editable\'">\n\t\t\t\t<input class="scribble-file-camera selectBackground" type="file" accept="image/*" capture="camera">\n\t\t\t\t<nav ng-if="editable" class="scribble-actions navbar navbar-default" style="width: {{width}}px">\n\t\t\t\t\t<div class="container-fluid">\n\t\t\t\t\t\t<ul class="nav navbar-nav">\n\t\t\t\t\t\t\t<li><a ng-click="clearSignature()" class="btn btn-danger"><i class="fa fa-trash"></i></a></li>\n\t\t\t\t\t\t\t<li ng-if="mode!=\'erase\'"><a ng-click="setMode(\'erase\')" tooltip="Eraser" class="btn btn-default"><i class="fa fa-eraser"></i></a></li>\n\t\t\t\t\t\t\t<li ng-if="mode==\'erase\'"><a ng-click="setMode(\'pen\')" tooltip="Pen" class="btn btn-default"><i class="fa fa-pencil"></i></a></li>\n\t\t\t\t\t\t\t<li ng-if="buttons.camera && mode!=\'streaming\' && !isMobile" tooltip="Set background image"><a ng-click="setBackground()" class="btn btn-default"><i class="fa fa-image"></i></a></li>\n\t\t\t\t\t\t\t<li ng-if="buttons.camera && mode==\'streaming\' && !isMobile" tooltip="Take screenshot"><a ng-click="screenshot()" class="btn btn-default"><i class="fa fa-camera"></i></a></li>\n\t\t\t\t\t\t\t<li ng-show="buttons.camera && isMobile">\n\t\t\t\t\t\t\t\t<a ng-click="requestCamera()" class="btn btn-default"><i class="fa fa-camera"></i></a>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</nav>\n\t\t\t\t<div class="scribble-area" style="width: {{width}}px; height: {{height}}px">\n\t\t\t\t\t<canvas class="scribble-board" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t\t\t<video class="scribble-video" ng-show="mode==\'streaming\'" height="{{height}}" width="{{width}}" autoplay></video>\n\t\t\t\t\t<canvas class="scribble-background" ng-show="mode!=\'streaming\'" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t\t\t<a ng-if="signatureReady" ng-click="submit()" class="btn btn-success btn-circular btn-fab"><i class="fa fa-fw fa-check fa-2x"></i></a>\n\t\t\t\t</div>\n\t\t\t\t<canvas class="scribble-composed" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t</div>\n\t\t',controller:["$scope","$element","$debounce",function($scope,$element,$debounce){var userAgent=navigator.userAgent;$scope.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(userAgent),$scope.requestCamera=function(){return $element.find("input[type=file]").trigger("click")},$scope.height||($scope.height=400),$scope.width||($scope.width=400),$scope.buttons=Object.assign({camera:!0},$scope.buttons);var canvas=$element[0].querySelector(".scribble-board"),ctx=canvas.getContext("2d");$scope.signaturePad=new SignaturePad(canvas);var videoStream,canvasBackground=$element[0].querySelector(".scribble-background"),ctxBackground=canvasBackground.getContext("2d"),composedImage=$element[0].querySelector(".scribble-composed"),ctxComposed=composedImage.getContext("2d"),video=$element[0].querySelector(".scribble-video");navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia,$scope.setBackground=function(){$scope.setMode("streaming"),navigator.getUserMedia&&navigator.getUserMedia({video:!0},function(stream){video.src=window.URL.createObjectURL(stream),videoStream=stream},function(){})},$scope.reversed=!1,$scope.screenshot=function(){if($scope.setMode("pen"),(video.paused||video.ended)&&console.log("no video"),video.paused||video.ended)return!1;$scope.reversed||($scope.reversed=!0,ctxBackground.translate(canvasBackground.width,0),ctxBackground.scale(-1,1)),ctxBackground.drawImage(video,0,0,$scope.width,$scope.height),videoStream.getTracks()[0].stop()},$scope.clearSignature=function(){return $scope.signaturePad.clear()},$scope.signaturePad.onBegin=function(){return $scope.$applyAsync(function(){return $scope.signatureReady=!1})},$scope.signaturePad.onEnd=$debounce(function(){return $scope.$applyAsync(function(){$scope.editable?$scope.signatureReady=!0:$scope.submit()})},1500,!1),$scope.mode="pen",$scope.setMode=function(mode){return $scope.mode=mode},$scope.$watch("mode",function(newVal,oldVal){"erase"==newVal&&newVal!==oldVal?($scope.oldStroke={oldComposition:ctx.globalCompositeOperation,minWidth:$scope.signaturePad.minWidth,maxWidth:$scope.signaturePad.maxWidth},ctx.globalCompositeOperation="destination-out",$scope.signaturePad.minWidth=6,$scope.signaturePad.maxWidth=8):"erase"==oldVal&&(ctx.globalCompositeOperation=$scope.oldStroke.oldComposition,$scope.signaturePad.minWidth=$scope.oldStroke.minWidth,$scope.signaturePad.maxWidth=$scope.oldStroke.maxWidth)});var selectBackground=$element[0].querySelector(".selectBackground");selectBackground.addEventListener("change",function(e){var backgroundSrc=selectBackground.files[0],reader=new FileReader;reader.onload=function(event){var image=new Image;window.devicePixelRatio;image.src=event.target.result,image.onload=function(){ctxBackground.clearRect(0,0,canvas.width,canvas.height),ctxBackground.drawImage(image,0,0,canvasBackground.width,canvasBackground.height)}},reader.readAsDataURL(backgroundSrc)}),$scope.getSignatureImage=function(){return ctxComposed.clearRect(0,0,composedImage.width,composedImage.height),ctxComposed.drawImage(canvasBackground,0,0),ctxComposed.drawImage(canvas,0,0),composedImage.toDataURL()},$scope.submit=function(){var image=$scope.getSignatureImage();$scope.callback({image:image})}}]}});