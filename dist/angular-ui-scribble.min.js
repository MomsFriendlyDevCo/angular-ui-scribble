"use strict";angular.module("angular-ui-scribble",[]).directive("uiScribble",function(){return{scope:{config:"=?",callbackFn:"&",callbackBtn:"&",buttons:"=?"},template:'\n\t\t\t<div class="scribble">\n\t\t\t\t<nav class="scribble-actions navbar navbar-default" style="width: {{scribbleWidth}}px">\n\t\t\t\t\t<div class="container-fluid">\n\t\t\t\t\t\t<ul class="nav navbar-nav">\n\t\t\t\t\t\t\t<li><a ng-click="clearSignature()" class="btn btn-danger"><i class="fa fa-trash"></i></a></li>\n\t\t\t\t\t\t\t<li ng-if="mode!=\'erase\'"><a ng-click="setMode(\'erase\')" tooltip="Eraser" class="btn btn-default"><i class="fa fa-eraser"></i></a></li>\n\t\t\t\t\t\t\t<li ng-if="mode==\'erase\'"><a ng-click="setMode(\'pen\')" tooltip="Pen" class="btn btn-default"><i class="fa fa-pencil"></i></a></li>\n\t\t\t\t\t\t\t<li ng-if="buttons.camera && mode!=\'streaming\' && !isMobile" tooltip="Set background image"><a ng-click="setBackground()" class="btn btn-default"><i class="fa fa-image"></i></a></li>\n\t\t\t\t\t\t\t<li ng-if="buttons.camera && mode==\'streaming\' && !isMobile" tooltip="Take screenshot"><a ng-click="screenshot()" class="btn btn-default"><i class="fa fa-camera"></i></a></li>\n\t\t\t\t\t\t\t<li><input ng-show="buttons.camera" class="selectBackground" type="file" accept="image/*" capture="camera"></lis>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</nav>\n\t\t\t\t<div class="scribble-area" style="width: {{scribbleWidth}}px; height: {{scribbleWidth}}px">\n\t\t\t\t\t<canvas class="scribble-board" height="{{scribbleHeight}}" width="{{scribbleWidth}}"></canvas>\n\t\t\t\t\t<video class="scribble-video" ng-show="mode==\'streaming\'" height="{{scribbleHeight}}" width="{{scribbleWidth}}" autoplay></video>\n\t\t\t\t\t<canvas class="scribble-background" ng-show="mode!=\'streaming\'" height="{{scribbleHeight}}" width="{{scribbleWidth}}"></canvas>\n\t\t\t\t\t<a ng-if="signatureReady" ng-click="callbackBtn({signature: getSignatureImage()})" class="btn btn-success btn-circular btn-fab"><i class="fa fa-fw fa-check fa-2x"></i></a>\n\t\t\t\t</div>\n\t\t\t\t<canvas class="scribble-composed" ng-show=false height="{{scribbleHeight}}" width="{{scribbleWidth}}" ></canvas>\n\t\t\t</div>\n\t\t',controller:["$scope","$element","$attrs",function($scope,$element,$attrs){function handleVideo(stream){video.src=window.URL.createObjectURL(stream),videoStream=stream}function videoError(){}function signatureReady(){$scope.$applyAsync(function(){if($attrs.callbackFn&&"function"==typeof $scope.callbackFn){var image=$scope.getSignatureImage();$scope.callbackFn({signature:image})}else $attrs.callbackBtn&&"function"==typeof $scope.callbackBtn&&($scope.signatureReady=!0)})}function loadBackground(dataUrl){var image=new Image;window.devicePixelRatio;image.src=dataUrl,image.onload=function(){ctxBackground.clearRect(0,0,canvas.width,canvas.height),ctxBackground.drawImage(image,0,0,canvasBackground.width,canvasBackground.height)}}$scope.isMobile=!1,$scope.mode="pen",$scope.signaturePad,$scope.scribbleHeight=400,$scope.scribbleWidth=400,$scope.buttons=$scope.buttons||{camera:!0};var canvas=$element[0].querySelector(".scribble-board"),ctx=canvas.getContext("2d"),canvasBackground=$element[0].querySelector(".scribble-background"),ctxBackground=canvasBackground.getContext("2d"),composedImage=$element[0].querySelector(".scribble-composed"),ctxComposed=composedImage.getContext("2d"),reversed=!1;$scope.signaturePad=new SignaturePad(canvas);var videoStream,video=$element[0].querySelector(".scribble-video");navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia,$scope.setBackground=function(){$scope.setMode("streaming"),navigator.getUserMedia&&navigator.getUserMedia({video:!0},handleVideo,videoError)},$scope.screenshot=function(){if($scope.setMode("pen"),(video.paused||video.ended)&&console.log("no video"),video.paused||video.ended)return!1;reversed||(reversed=!0,ctxBackground.translate(canvasBackground.width,0),ctxBackground.scale(-1,1)),ctxBackground.drawImage(video,0,0,$scope.scribbleWidth,$scope.scribbleHeight),videoStream.getTracks()[0].stop()},$scope.config.getSignaturePad=function(){return signaturePad},$scope.config.getSignatureImage=$scope.getSignatureImage,$scope.getSignatureImage=function(){return ctxComposed.clearRect(0,0,composedImage.width,composedImage.height),ctxComposed.drawImage(canvasBackground,0,0),ctxComposed.drawImage(canvas,0,0),composedImage.toDataURL()},$scope.clearSignature=function(){$scope.signaturePad.clear()},$scope.signaturePad.onBegin=function(e){$scope.$applyAsync(function(){$scope.signatureReady=!1})},$scope.signaturePad.onEnd=_.debounce(signatureReady,1500),$scope.setMode=function(mode){$scope.mode=mode},$scope.$watch("mode",function(newVal,oldVal){"erase"==newVal&&newVal!==oldVal?($scope.oldStroke={oldComposition:ctx.globalCompositeOperation,minWidth:$scope.signaturePad.minWidth,maxWidth:$scope.signaturePad.maxWidth},ctx.globalCompositeOperation="destination-out",$scope.signaturePad.minWidth=6,$scope.signaturePad.maxWidth=8):"erase"==oldVal&&(ctx.globalCompositeOperation=$scope.oldStroke.oldComposition,$scope.signaturePad.minWidth=$scope.oldStroke.minWidth,$scope.signaturePad.maxWidth=$scope.oldStroke.maxWidth)});var reader,selectBackground=$element[0].querySelector(".selectBackground");selectBackground.addEventListener("change",function(e){var backgroundSrc=selectBackground.files[0];reader=new FileReader,reader.onload=function(event){loadBackground(event.target.result)},reader.readAsDataURL(backgroundSrc)})}]}});