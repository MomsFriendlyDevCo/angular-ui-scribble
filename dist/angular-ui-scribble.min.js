"use strict";angular.module("angular-ui-scribble",[]).factory("$debounce",["$timeout",function(c){return function(n,r,s){r=angular.isUndefined(r)?0:r,s=!!angular.isUndefined(s)||s;var o=0;return function(){var t,e=this,a=arguments,i=(t=++o,function(){if(t===o)return n.apply(e,a)});return c(i,r,s)}}}]).directive("uiScribble",function(){return{scope:{callback:"&",editable:"<",buttons:"<",width:"@?",height:"@?",sizes:"<",colors:"<"},template:'\n\t\t\t<div class="scribble" ng-class="editable ? \'scribble-editable\' : \'scribble-not-editable\'">\n\t\t\t\t<input class="scribble-file-camera selectBackground-image" type="file" accept="image/*" >\n\t\t\t\t<input class="scribble-file-camera selectBackground-video" type="file" accept="image/*" capture="camera">\n\t\t\t\t<nav ng-if="editable" class="scribble-actions navbar navbar-default" style="width: {{width}}px">\n\t\t\t\t\t<div class="navbar-form pull-left">\n\t\t\t\t\t\t<div ng-if="buttons.camera" class="btn-group">\n\t\t\t\t\t\t\t<a ng-if="mode!=\'streaming\' && !isMobile" tooltip="Set background image" ng-click="setBackground()" class="btn btn-primary"><i class="fa fa-camera"></i></a>\n\t\t\t\t\t\t\t<a ng-if="mode==\'streaming\' && !isMobile" tooltip="Take screenshot" ng-click="screenshot()" class="btn btn-primary"><i class="fa fa-camera"></i></a>\n\t\t\t\t\t\t\t<a ng-if="isMobile" ng-click="requestCamera(\'video\')" class="btn btn-primary"><i class="fa fa-camera"></i></a>\n\t\t\t\t\t\t\t<a ng-click="requestCamera(\'image\')" class="btn btn-primary"><i class="fa fa-paperclip"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="btn-group">\n\t\t\t\t\t\t\t<a ng-click="setMode(\'pen\')" ng-class="mode==\'pen\' && \'active\'" tooltip="Pen" class="btn btn-default"><i class="fa fa-pencil"></i></a>\n\t\t\t\t\t\t\t<a ng-if="buttons.eraser" ng-click="setMode(\'erase\')" ng-class="mode==\'erase\' && \'active\'" tooltip="Eraser" class="btn btn-default"><i class="fa fa-eraser"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div ng-if="buttons.sizes" class="btn-group scribble-pens">\n\t\t\t\t\t\t\t<a ng-repeat="size in sizes" ng-click="setPenSize(size)" ng-class="penSize==size && \'active\'" tooltip="Pen Size {{size}}" class="btn btn-default"><i class="fa fa-circle" style="transform: scale({{$index / sizes.length + 0.2}})"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div ng-if="buttons.colors" class="btn-group scribble-colors">\n\t\t\t\t\t\t\t<a ng-repeat="color in colors" ng-click="setPenColor(color)" ng-class="penColor==color && \'active\'" tooltip="Pen Color {{color}}" class="btn btn-default"><i class="fa fa-square" style="color: {{color}}"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div ng-if="buttons.clear" class="navbar-form pull-right">\n\t\t\t\t\t\t<div class="btn-group">\n\t\t\t\t\t\t\t<a ng-click="clearSignature()" class="btn btn-danger"><i class="fa fa-trash"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</nav>\n\t\t\t\t<div class="scribble-area" style="width: {{width}}px; height: {{height}}px">\n\t\t\t\t\t<canvas class="scribble-board" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t\t\t<video class="scribble-video" ng-show="mode==\'streaming\'" height="{{height}}" width="{{width}}" autoplay></video>\n\t\t\t\t\t<canvas class="scribble-background" ng-show="mode!=\'streaming\'" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t\t\t<a ng-if="signatureReady" ng-click="submit()" class="btn btn-success btn-circular btn-fab"><i class="fa fa-fw fa-check fa-2x"></i></a>\n\t\t\t\t</div>\n\t\t\t\t<canvas class="scribble-composed" height="{{height}}" width="{{width}}"></canvas>\n\t\t\t</div>\n\t\t',controller:["$scope","$element","$debounce",function(i,e,t){var a=navigator.userAgent;i.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(a),i.requestCamera=function(t){i.setMode("pen"),s&&s.getTracks()[0]&&s.getTracks()[0].stop(),e.find(".selectBackground-"+t).trigger("click")},i.height||(i.height=200),i.width||(i.width=490),i.sizes||(i.sizes=[1,2,3,4,5]),i.colors||(i.colors=["#000","#337AB7","#3C763D","#8A6D3B","#A94442"]),i.buttons=Object.assign({camera:!0,colors:!0,clear:!0,eraser:!0,sizes:!0},i.buttons);var n=e[0].querySelector(".scribble-board"),r=n.getContext("2d");i.signaturePad=new SignaturePad(n);var s,o=e[0].querySelector(".scribble-background"),c=o.getContext("2d"),l=e[0].querySelector(".scribble-composed"),d=l.getContext("2d"),g=e[0].querySelector(".scribble-video");navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia,i.setBackground=function(){navigator.getUserMedia&&navigator.getUserMedia({video:!0},function(t){i.$applyAsync(function(){i.signatureReady=!1,c&&c.clearRect(0,0,n.width,n.height),g.srcObject=t,s=t,i.setMode("streaming")})},function(){return alert("Camera unavailable")})},i.reversed=!1,i.flipContext=function(){i.reversed=!i.reversed,c.translate(o.width,0),c.scale(-1,1)},i.screenshot=function(){if(i.setMode("pen"),i.signatureReady=!1,(g.paused||g.ended)&&console.log("no video"),g.paused||g.ended)return!1;i.reversed||i.flipContext(),c.drawImage(g,0,0,i.width,i.height),s.getTracks()[0].stop(),i.signatureReady=!0},i.clearSignature=function(){return i.signaturePad.clear()},i.signaturePad.onBegin=function(){return i.$applyAsync(function(){return i.signatureReady=!1})},i.signaturePad.onEnd=t(function(){return i.$applyAsync(function(){i.editable?i.signatureReady=!0:i.submit()})},1500,!1),i.mode="pen",i.setMode=function(t){return i.mode=t},i.$watch("mode",function(t,e){"erase"==t&&t!==e?(i.oldStroke={oldComposition:r.globalCompositeOperation,minWidth:i.signaturePad.minWidth,maxWidth:i.signaturePad.maxWidth},r.globalCompositeOperation="destination-out",i.signaturePad.minWidth=6,i.signaturePad.maxWidth=8):"erase"==e&&(r.globalCompositeOperation=i.oldStroke.oldComposition,i.signaturePad.minWidth=i.oldStroke.minWidth,i.signaturePad.maxWidth=i.oldStroke.maxWidth)}),i.penSize=1,i.setPenSize=function(t){i.penSize=t,i.signaturePad.minWidth=t-.5,i.signaturePad.maxWidth=t+1.5},i.penColor="#000",i.setPenColor=function(t){i.penColor=t,i.signaturePad.penColor=t};var u=e[0].querySelector(".selectBackground-image"),b=e[0].querySelector(".selectBackground-video");function f(a){return function(){var t,e;a.files.length&&(t=a.files[0],(e=new FileReader).onload=function(t){var e=new Image;e.src=t.target.result,e.onload=function(){return t=e,void i.$applyAsync(function(){i.reversed&&i.flipContext(),i.signatureReady=!0,c.clearRect(0,0,n.width,n.height),c.drawImage(t,0,0,o.width,o.height)});var t}},e&&e.readAsDataURL(t))}}u.addEventListener("change",f(u)),b.addEventListener("change",f(b)),i.getDataURI=function(){return d.clearRect(0,0,l.width,l.height),d.drawImage(o,0,0),d.drawImage(n,0,0),l.toDataURL()},i.getBlob=function(t){for(var e=atob(t.replace(/^data:image\/png;base64,/,"")),a=new Uint8Array(e.length),i=0;i<e.length;i++)a[i]=e.charCodeAt(i);return new Blob([a],{type:"image/png"})},i.submit=function(){var t=i.getDataURI();i.callback({dataURI:t,blob:i.getBlob(t)})},i.$on("angular-ui-scribble.submit",i.submit)}]}});